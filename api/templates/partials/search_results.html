<!-- Search Results Fragment for HTMX -->
{% if total is defined and total > 0 %}
<!-- Results Summary Header -->
<div class="cds-results-summary">
    <div class="cds-results-summary__text">
        <span class="cds-results-summary__count">Found <strong>{{ "{:,}".format(total) }}</strong> recipes</span>
        {% if query %}<span class="cds-results-summary__query">for "{{ query }}"</span>{% endif %}
        <span class="cds-results-summary__time">in {{ took_ms }}ms</span>
    </div>
</div>

<!-- Recipe Cards Grid -->
<div class="cds-recipe-grid" id="recipe-grid">
    {% for recipe in recipes %}
    <article class="cds-recipe-card">
        <!-- Card Header -->
        <div class="cds-recipe-card__header">
            <h3 class="cds-recipe-card__title">{{ recipe.recipe_title }}</h3>
            {% if recipe.difficulty %}
            <span class="cds-tag cds-tag--difficulty cds-tag--{{ recipe.difficulty|lower }}">
                {% if recipe.difficulty|lower == 'easy' %}
                <iconify-icon icon="carbon:skill-level-basic"></iconify-icon>
                {% elif recipe.difficulty|lower == 'medium' %}
                <iconify-icon icon="carbon:skill-level-intermediate"></iconify-icon>
                {% else %}
                <iconify-icon icon="carbon:skill-level-advanced"></iconify-icon>
                {% endif %}
                {{ recipe.difficulty|title }}
            </span>
            {% endif %}
        </div>

        <!-- Description -->
        {% if recipe.description %}
        <p class="cds-recipe-card__description">{{ recipe.description[:150] }}{% if recipe.description|length > 150 %}...{% endif %}</p>
        {% endif %}

        <!-- Tags Row -->
        <div class="cds-recipe-card__tags">
            {% if recipe.cuisine_list %}
            {% for cuisine in recipe.cuisine_list[:3] %}
            <span class="cds-tag cds-tag--cuisine">
                <iconify-icon icon="carbon:restaurant"></iconify-icon>
                {{ cuisine|title }}
            </span>
            {% endfor %}
            {% if recipe.cuisine_list|length > 3 %}
            <span class="cds-tag cds-tag--more">+{{ recipe.cuisine_list|length - 3 }}</span>
            {% endif %}
            {% endif %}

            {% if recipe.is_vegan %}
            <span class="cds-tag cds-tag--dietary cds-tag--vegan">Vegan</span>
            {% elif recipe.is_vegetarian %}
            <span class="cds-tag cds-tag--dietary cds-tag--vegetarian">Vegetarian</span>
            {% endif %}

            {% if recipe.is_gluten_free %}
            <span class="cds-tag cds-tag--dietary cds-tag--gf">GF</span>
            {% endif %}

            {% if recipe.is_dairy_free %}
            <span class="cds-tag cds-tag--dietary cds-tag--df">DF</span>
            {% endif %}

            {% if recipe.is_nut_free %}
            <span class="cds-tag cds-tag--dietary cds-tag--nf">NF</span>
            {% endif %}
        </div>

        <!-- Time & Health Info -->
        <div class="cds-recipe-card__meta">
            <div class="cds-recipe-card__times">
                {% if recipe.est_prep_time_min %}
                <span class="cds-recipe-card__time">
                    <iconify-icon icon="carbon:time"></iconify-icon>
                    {{ recipe.est_prep_time_min }} min prep
                </span>
                {% endif %}
                {% if recipe.est_cook_time_min %}
                <span class="cds-recipe-card__time">
                    <iconify-icon icon="carbon:flame"></iconify-icon>
                    {{ recipe.est_cook_time_min }} min cook
                </span>
                {% endif %}
            </div>

            {% if recipe.healthiness_score %}
            <div class="cds-recipe-card__health">
                <span class="cds-recipe-card__health-label">
                    <iconify-icon icon="carbon:favorite"></iconify-icon>
                    Health
                </span>
                <div class="cds-recipe-card__health-bar">
                    <div class="cds-recipe-card__health-fill" style="width: {{ recipe.healthiness_score }}%"></div>
                </div>
                <span class="cds-recipe-card__health-score">{{ recipe.healthiness_score }}</span>
            </div>
            {% endif %}
        </div>
    </article>
    {% endfor %}

    <!-- Infinite Scroll Sentinel (inside grid) -->
    {% set next_from = (from_|default(0)) + (size|default(10)) %}
    {% if next_from < total %}
    <div class="cds-infinite-scroll-sentinel"
         hx-post="/search"
         hx-trigger="intersect once"
         hx-swap="outerHTML"
         hx-include="#search-form, #filter-form"
         hx-vals='{"from": {{ next_from }}, "append": "true"}'>
        <div class="cds-loading-indicator">
            <iconify-icon icon="carbon:circle-dash" class="cds-loading-spinner"></iconify-icon>
            <span>Loading more recipes...</span>
        </div>
    </div>
    {% endif %}
</div>

{% elif query is defined and query %}
<!-- No Results State -->
<div class="cds-empty-state cds-empty-state--no-results">
    <div class="cds-empty-state__icon">
        <iconify-icon icon="carbon:search"></iconify-icon>
    </div>
    <h3 class="cds-empty-state__title">No recipes found</h3>
    <p class="cds-empty-state__description">We couldn't find any recipes for "<strong>{{ query }}</strong>"</p>
    <div class="cds-empty-state__suggestions">
        <p>Try:</p>
        <ul>
            <li>Using different keywords (e.g., "pasta" instead of "spaghetti")</li>
            <li>Checking your spelling</li>
            <li>Using broader terms (e.g., "chicken" instead of "chicken parmesan")</li>
            <li>Removing some filters</li>
        </ul>
    </div>
</div>

{% else %}
<!-- Initial Empty State -->
<div class="cds-empty-state cds-empty-state--initial">
    <div class="cds-empty-state__icon">
        <iconify-icon icon="carbon:noodle-bowl"></iconify-icon>
    </div>
    <h3 class="cds-empty-state__title">Start searching to discover recipes</h3>
    <p class="cds-empty-state__description">Search through 62,000+ recipes from cuisines around the world</p>
    <div class="cds-empty-state__suggestions">
        <p>Try searching for:</p>
        <div class="cds-suggestion-chips">
            <button type="button" class="cds-suggestion-chip" onclick="suggestSearch('chocolate cake')">
                <iconify-icon icon="carbon:cake"></iconify-icon>
                chocolate cake
            </button>
            <button type="button" class="cds-suggestion-chip" onclick="suggestSearch('pasta')">
                <iconify-icon icon="carbon:restaurant"></iconify-icon>
                pasta
            </button>
            <button type="button" class="cds-suggestion-chip" onclick="suggestSearch('chicken')">
                <iconify-icon icon="carbon:restaurant"></iconify-icon>
                chicken
            </button>
            <button type="button" class="cds-suggestion-chip" onclick="suggestSearch('salad')">
                <iconify-icon icon="carbon:apple"></iconify-icon>
                salad
            </button>
        </div>
    </div>
</div>
<script>
function suggestSearch(term) {
    const searchInput = document.querySelector('.cds-search__input');
    if (searchInput) {
        searchInput.value = term;
        searchInput.dispatchEvent(new Event('keyup'));
        // Show clear button
        const clearButton = document.querySelector('.cds-search__clear');
        if (clearButton) clearButton.style.display = 'flex';
    }
}
</script>
{% endif %}